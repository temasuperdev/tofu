name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      backend_image_tag:
        description: 'Backend image tag to deploy'
        required: true
        default: 'latest'
      frontend_image_tag:
        description: 'Frontend image tag to deploy'
        required: true
        default: 'latest'
  push:
    branches: [ main, init ]
  repository_dispatch:
    types: [deploy-production]

env:
  REGISTRY: ghcr.io

jobs:
 deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Add Helm repositories
      run: |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo add jetstack https://charts.jetstack.io
        helm repo update

    - name: Install k3s
      run: |
        curl -sfL https://get.k3s.io | sh -
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        sudo chmod 644 /etc/rancher/k3s/k3s.yaml
        kubectl cluster-info
        kubectl get nodes

    - name: Verify cluster connectivity
      run: |
        kubectl cluster-info
        kubectl get pods -A
        
    - name: Update Helm release
      run: |
        helm dependency update ./charts/notes-app
        # Удаляем проблемные NetworkPolicy перед обновлением
        kubectl delete networkpolicy frontend-netpol backend-netpol postgresql-netpol --namespace note --ignore-not-found=true
        # Удаляем существующий Certificate, если он был создан без аннотаций Helm
        # Проверяем существование и удаляем с правильным API group
        if kubectl get certificate notes-tls-cert -n note >/dev/null 2>&1; then
          echo "Certificate exists, checking annotations..."
          RELEASE_NAME=$(kubectl get certificate notes-tls-cert -n note -o jsonpath='{.metadata.annotations.meta\.helm\.sh/release-name}' 2>/dev/null || echo "")
          if [ "$RELEASE_NAME" != "notes-app" ]; then
            echo "Certificate exists without correct Helm annotations, attempting to remove..."
            # Пытаемся удалить
            kubectl delete certificate notes-tls-cert --namespace note --wait=false --timeout=5s 2>/dev/null || true
            # Удаляем finalizers если они есть
            kubectl patch certificate notes-tls-cert --namespace note -p '{"metadata":{"finalizers":[]}}' --type=merge --ignore-not-found=true 2>/dev/null || true
            # Повторное удаление после удаления finalizers
            kubectl delete certificate notes-tls-cert --namespace note --ignore-not-found=true --timeout=5s 2>/dev/null || true
            # Если удаление не сработало, добавляем аннотации для "усыновления" ресурса
            if kubectl get certificate notes-tls-cert -n note >/dev/null 2>&1; then
              echo "Certificate still exists, adding Helm annotations to adopt it..."
              kubectl annotate certificate notes-tls-cert -n note "meta.helm.sh/release-name=notes-app" "meta.helm.sh/release-namespace=note" --overwrite || true
            else
              echo "Certificate successfully removed"
            fi
            sleep 2
          fi
        fi
        # Удаляем существующий ClusterIssuer, если он был создан без аннотаций Helm
        if kubectl get clusterissuer letsencrypt-prod >/dev/null 2>&1; then
          RELEASE_NAME_CI=$(kubectl get clusterissuer letsencrypt-prod -o jsonpath='{.metadata.annotations.meta\.helm\.sh/release-name}' 2>/dev/null || echo "")
          if [ "$RELEASE_NAME_CI" != "notes-app" ]; then
            echo "ClusterIssuer exists without correct Helm annotations, attempting to remove..."
            kubectl delete clusterissuer letsencrypt-prod --wait=false --timeout=5s 2>/dev/null || true
            kubectl patch clusterissuer letsencrypt-prod -p '{"metadata":{"finalizers":[]}}' --type=merge --ignore-not-found=true 2>/dev/null || true
            kubectl delete clusterissuer letsencrypt-prod --ignore-not-found=true --timeout=5s 2>/dev/null || true
            # Если удаление не сработало, добавляем аннотации для "усыновления" ресурса
            if kubectl get clusterissuer letsencrypt-prod >/dev/null 2>&1; then
              echo "ClusterIssuer still exists, adding Helm annotations to adopt it..."
              kubectl annotate clusterissuer letsencrypt-prod "meta.helm.sh/release-name=notes-app" "meta.helm.sh/release-namespace=note" --overwrite || true
            else
              echo "ClusterIssuer successfully removed"
            fi
            sleep 2
          fi
        fi
        kubectl delete secret notes-app-db-secret notes-app-app-secret --namespace note || true
        kubectl delete secret notes-app-postgresql --namespace note || true
        helm uninstall notes-app --namespace note || true
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update
        helm upgrade --install notes-app ./charts/notes-app \
          --set backend.image.repository=${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-backend \
          --set backend.image.tag=${{ github.event.inputs.backend_image_tag }} \
          --set backend.image.pullPolicy=IfNotPresent \
          --set frontend.image.repository=${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-frontend \
          --set frontend.image.tag=${{ github.event.inputs.frontend_image_tag }} \
          --set frontend.image.pullPolicy=IfNotPresent \
          --set global.repositoryOwner=${{ github.repository_owner }} \
          --namespace note --create-namespace \
          -f ./charts/notes-app/values.yaml \
          --timeout 10m

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/notes-app-backend --timeout=5m -n note
        kubectl rollout status deployment/notes-app-frontend --timeout=5m -n note

    - name: Run health checks
      run: |
        # Ждем пока ingress будет готов
        kubectl wait --for=condition=ready ingress/notes-app-ingress -n note --timeout=300s
        # Проверяем доступность сайта
        curl -f https://serv.temasuug.ru/health || exit 1
name: Unified CI/CD Pipeline

on:
  push:
    branches: [ main, init ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'charts/**'
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'charts/**'
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'docker-compose.yml'

env:
  REGISTRY: ghcr.io

jobs:
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pydantic[email]
        pip install -r requirements.txt

    - name: Run tests
      run: |
        PYTHONPATH=. pytest --cov=app --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: codecov-umbrella

  frontend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run tests
      run: ./run_tests.sh

    - name: Run build
      run: npm run build
      env:
        CI: false

  test:
    name: Run all tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    steps:
      - name: Tests completed
        run: echo "All tests passed successfully!"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/init')
    permissions:
      packages: write
      contents: read

    strategy:
      matrix:
        service: [backend, frontend]

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./${{ matrix.service }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-${{ matrix.service }}:latest
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-${{ matrix.service }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/init'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
        kubectl cluster-info
        kubectl get nodes

    - name: Update Helm release
      run: |
        helm dependency update ./charts/notes-app
        # Удаляем проблемные NetworkPolicy перед обновлением
        kubectl delete networkpolicy frontend-netpol backend-netpol postgresql-netpol --namespace note --ignore-not-found=true
        # Удаляем существующий Certificate, если он был создан без аннотаций Helm
        # Проверяем существование и удаляем с правильным API group
        if kubectl get certificate notes-tls-cert -n note >/dev/null 2>&1; then
          echo "Certificate exists, checking annotations..."
          RELEASE_NAME=$(kubectl get certificate notes-tls-cert -n note -o jsonpath='{.metadata.annotations.meta\.helm\.sh/release-name}' 2>/dev/null || echo "")
          if [ "$RELEASE_NAME" != "notes-app" ]; then
            echo "Certificate exists without correct Helm annotations, attempting to remove..."
            # Пытаемся удалить
            kubectl delete certificate notes-tls-cert --namespace note --wait=false --timeout=5s 2>/dev/null || true
            # Удаляем finalizers если они есть
            kubectl patch certificate notes-tls-cert --namespace note -p '{"metadata":{"finalizers":[]}}' --type=merge --ignore-not-found=true 2>/dev/null || true
            # Повторное удаление после удаления finalizers
            kubectl delete certificate notes-tls-cert --namespace note --ignore-not-found=true --timeout=5s 2>/dev/null || true
            # Если удаление не сработало, добавляем аннотации для "усыновления" ресурса
            if kubectl get certificate notes-tls-cert -n note >/dev/null 2>&1; then
              echo "Certificate still exists, adding Helm annotations to adopt it..."
              kubectl annotate certificate notes-tls-cert -n note "meta.helm.sh/release-name=notes-app" "meta.helm.sh/release-namespace=note" --overwrite || true
            else
              echo "Certificate successfully removed"
            fi
            sleep 2
          fi
        fi
        # Удаляем существующий ClusterIssuer, если он был создан без аннотаций Helm
        if kubectl get clusterissuer letsencrypt-prod >/dev/null 2>&1; then
          RELEASE_NAME_CI=$(kubectl get clusterissuer letsencrypt-prod -o jsonpath='{.metadata.annotations.meta\.helm\.sh/release-name}' 2>/dev/null || echo "")
          if [ "$RELEASE_NAME_CI" != "notes-app" ]; then
            echo "ClusterIssuer exists without correct Helm annotations, attempting to remove..."
            kubectl delete clusterissuer letsencrypt-prod --wait=false --timeout=5s 2>/dev/null || true
            kubectl patch clusterissuer letsencrypt-prod -p '{"metadata":{"finalizers":[]}}' --type=merge --ignore-not-found=true 2>/dev/null || true
            kubectl delete clusterissuer letsencrypt-prod --ignore-not-found=true --timeout=5s 2>/dev/null || true
            # Если удаление не сработало, добавляем аннотации для "усыновления" ресурса
            if kubectl get clusterissuer letsencrypt-prod >/dev/null 2>&1; then
              echo "ClusterIssuer still exists, adding Helm annotations to adopt it..."
              kubectl annotate clusterissuer letsencrypt-prod "meta.helm.sh/release-name=notes-app" "meta.helm.sh/release-namespace=note" --overwrite || true
            else
              echo "ClusterIssuer successfully removed"
            fi
            sleep 2
          fi
        fi
        # Обновляем Helm релиз с указанием namespace
        helm upgrade --install notes-app ./charts/notes-app \
          --set backend.image.repository=${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-backend \
          --set backend.image.tag=${{ github.sha }} \
          --set backend.image.pullPolicy=IfNotPresent \
          --set frontend.image.repository=${{ env.REGISTRY }}/${{ github.repository_owner }}/notes-frontend \
          --set frontend.image.tag=${{ github.sha }} \
          --set frontend.image.pullPolicy=IfNotPresent \
          --set global.repositoryOwner=${{ github.repository_owner }} \
          --namespace note --create-namespace \
          -f ./charts/notes-app/values.yaml \
          --timeout 10m

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/notes-app-backend --timeout=5m -n note
        kubectl rollout status deployment/notes-app-frontend --timeout=5m -n note
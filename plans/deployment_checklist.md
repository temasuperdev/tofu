# Чек-лист деплоя микросервисного приложения заметок

## 1. Подготовка к деплою

### 1.1. Проверка готовности кода
- [ ] Все тесты проходят успешно (unit, integration, e2e)
- [ ] Код прошел проверку линтерами
- [ ] Покрытие кода тестами соответствует требованиям (>80% для backend)
- [ ] Нет уязвимостей в зависимостях
- [ ] Документация обновлена

### 1.2. Проверка инфраструктуры
- [ ] k3s кластер работает корректно
- [ ] Доступ к кластеру настроен
- [ ] DNS запись serv.temasuug.ru указывает на IP кластера
- [ ] Traefik ingress controller установлен и работает
- [ ] Cert-Manager установлен для управления TLS сертификатами
- [ ] Persistent Volumes доступны для хранения данных

### 1.3. Подготовка образов
- [ ] Docker образы собраны и загружены в registry
- [ ] Образы протестированы на уязвимость
- [ ] Версии образов соответствуют последнему релизу

## 2. Деплой в staging окружение

### 2.1. Применение манифестов
- [ ] Namespace создан: `kubectl apply -f k8s/namespace.yaml`
- [ ] PostgreSQL развернут: `kubectl apply -f k8s/postgres/ -n notes-app-staging`
- [ ] Ждем готовности PostgreSQL: `kubectl wait --for=condition=ready pod -l app=postgres -n notes-app-staging --timeout=300s`
- [ ] Backend развернут: `kubectl apply -f k8s/backend/ -n notes-app-staging`
- [ ] Frontend развернут: `kubectl apply -f k8s/frontend/ -n notes-app-staging`
- [ ] Ingress применен: `kubectl apply -f k8s/ingress-staging.yaml -n notes-app-staging`

### 2.2. Проверка работоспособности
- [ ] Все поды находятся в состоянии Running
- [ ] Сервисы доступны внутри кластера
- [ ] Веб-интерфейс доступен по адресу staging.serv.temasuug.ru
- [ ] API доступен и отвечает на запросы
- [ ] База данных подключена и функционирует
- [ ] Работают все основные функции приложения

### 2.3. Тестирование в staging
- [ ] Регистрация нового пользователя
- [ ] Создание, чтение, обновление и удаление заметок
- [ ] Проверка авторизации и аутентификации
- [ ] Проверка безопасности (ограничения доступа к чужим заметкам)
- [ ] Проверка HTTPS и редиректа с HTTP

## 3. Деплой в production

### 3.1. Подготовка
- [ ] Уведомлены заинтересованные стороны о деплое
- [ ] Создана резервная копия текущего production окружения
- [ ] Подготовлен план отката в случае проблем
- [ ] Выбрано подходящее время для деплоя (желательно вне пиковых часов)

### 3.2. Деплой PostgreSQL (если требуется обновление)
- [ ] Создание бэкапа текущей базы данных
- [ ] Применение манифестов PostgreSQL: `kubectl apply -f k8s/postgres/ -n notes-app`
- [ ] Проверка готовности: `kubectl wait --for=condition=ready pod -l app=postgres -n notes-app --timeout=300s`

### 3.3. Деплой backend
- [ ] Обновление образа в deployment: `kubectl set image deployment/backend-deployment backend=ghcr.io/username/notes-app/backend:new-version -n notes-app`
- [ ] Проверка статуса деплоя: `kubectl rollout status deployment/backend-deployment -n notes-app`
- [ ] Проверка логов подов: `kubectl logs -l app=backend -n notes-app`
- [ ] Проверка работоспособности: `kubectl get pods -l app=backend -n notes-app`

### 3.4. Деплой frontend
- [ ] Обновление образа в deployment: `kubectl set image deployment/frontend-deployment frontend=ghcr.io/username/notes-app/frontend:new-version -n notes-app`
- [ ] Проверка статуса деплоя: `kubectl rollout status deployment/frontend-deployment -n notes-app`
- [ ] Проверка логов подов: `kubectl logs -l app=frontend -n notes-app`
- [ ] Проверка работоспособности: `kubectl get pods -l app=frontend -n notes-app`

### 3.5. Проверка после деплоя
- [ ] Приложение доступно по адресу serv.temasuug.ru
- [ ] HTTPS работает корректно
- [ ] Все функции приложения работают
- [ ] Нет ошибок в логах сервисов
- [ ] Метрики и мониторинг показывают нормальную работу

## 4. Проверки безопасности

### 4.1. Проверка конфигурации
- [ ] Network policies применяются корректно
- [ ] Pod Security Standards соблюдаются
- [ ] Secrets не содержат чувствительных данных в открытом виде
- [ ] RBAC политики настроены правильно

### 4.2. Проверка доступа
- [ ] Только авторизованные пользователи могут создавать заметки
- [ ] Пользователи не имеют доступа к чужим заметкам
- [ ] Права доступа к API проверяются корректно
- [ ] Защита от атак (XSS, CSRF, SQL injection) работает

## 5. Мониторинг и логирование

### 5.1. Проверка мониторинга
- [ ] Метрики собираются с всех сервисов
- [ ] Алерты настроены и работают
- [ ] Логи централизованно собираются
- [ ] Есть доступ к логам в случае необходимости

### 5.2. SLA метрики
- [ ] Время отклика API в пределах допустимого (например, < 500ms для 95% запросов)
- [ ] Доступность сервиса > 99.9%
- [ ] Уровень ошибок < 0.1%
- [ ] Потребление ресурсов в пределах нормы

## 6. План отката

### 6.1. В случае проблем
- [ ] Быстро переключить трафик обратно на предыдущую версию
- [ ] Восстановить из последнего бэкапа если необходимо
- [ ] Уведомить пользователей о временных трудностях
- [ ] Провести анализ причины проблемы
- [ ] Подготовить исправление и повторный деплой

### 6.2. Команды для отката
```bash
# Откат backend к предыдущей версии
kubectl rollout undo deployment/backend-deployment -n notes-app

# Откат frontend к предыдущей версии
kubectl rollout undo deployment/frontend-deployment -n notes-app

# Проверка статуса отката
kubectl rollout status deployment/backend-deployment -n notes-app
kubectl rollout status deployment/frontend-deployment -n notes-app
```

## 7. Последующие действия

### 7.1. После успешного деплоя
- [ ] Уведомить команду о завершении деплоя
- [ ] Обновить документацию если необходимо
- [ ] Задокументировать изменения
- [ ] Провести post-mortem анализ если были проблемы

### 7.2. Мониторинг после деплоя
- [ ] Наблюдение за метриками в течение 24 часов
- [ ] Проверка логов на наличие ошибок
- [ ] Сбор обратной связи от пользователей
- [ ] Анализ производительности после обновления